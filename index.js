(function(){"use strict";const s=window.Vue;function q(){return window.panel}function $(){return q().app}const y=s.computed;s.customRef,s.defineAsyncComponent,s.defineComponent,s.effectScope,s.getCurrentInstance,s.getCurrentScope,s.h,s.inject,s.isProxy,s.isReactive,s.isReadonly,s.isRef,s.isShallow,s.markRaw,s.nextTick,s.onActivated,s.onBeforeMount,s.onBeforeUnmount,s.onBeforeUpdate,s.onDeactivated,s.onErrorCaptured,s.onMounted,s.onRenderTracked,s.onRenderTriggered,s.onScopeDispose,s.onServerPrefetch,s.onUnmounted,s.onUpdated,s.provide,s.proxyRefs,s.reactive,s.readonly,s.ref,s.shallowReactive,s.shallowReadonly,s.shallowRef,s.toRaw,s.toRef,s.toRefs,s.triggerRef,s.unref,s.useAttrs,s.useCssModule,s.useCssVars,s.useListeners,s.useSlots,s.watch,s.watchEffect,s.watchPostEffect,s.watchSyncEffect;function k(u,e,t,n,o,l,r,c){var p=typeof u=="function"?u.options:u;return e&&(p.render=e,p.staticRenderFns=t,p._compiled=!0),{exports:u,options:p}}const R={__name:"view",props:{statistics:Object,jobs:Array,total:Number,status:{type:String,default:"pending"},page:{type:Number,default:1},timeRange:{type:String,default:"24h"},sortBy:{type:String,default:"created_at"},sortOrder:{type:String,default:"desc"},jobType:{type:String,default:""},jobTypes:{type:Array,default:()=>[]}},setup(u){const e=u,t=q(),n=$(),o=50,l=y(()=>(e.jobs??[]).map(a=>({id:a.id,name:a.name||a.type,type:a.type,queue:a.queue,status:a.status,attempts:a.attempts||0,created_at:a.created_at?new Date(a.created_at*1e3).toISOString():null,started_at:a.started_at?new Date(a.started_at*1e3).toISOString():null,completed_at:a.completed_at?new Date(a.completed_at*1e3).toISOString():null,failed_at:a.failed_at?new Date(a.failed_at*1e3).toISOString():null}))),r=y(()=>{var d,g,_,m,v,S,j,h;const a=e.statistics||{total:0,by_status:{}};return[{info:t.t("queues.total"),value:String(a.total||0)},{info:t.t("queues.status.pending"),value:String(((d=a.by_status)==null?void 0:d.pending)||0),theme:((g=a.by_status)==null?void 0:g.pending)>0?"yellow":null},{info:t.t("queues.status.running"),value:String(((_=a.by_status)==null?void 0:_.running)||0),theme:((m=a.by_status)==null?void 0:m.running)>0?"blue":null},{info:t.t("queues.status.completed"),value:String(((v=a.by_status)==null?void 0:v.completed)||0),theme:((S=a.by_status)==null?void 0:S.completed)>0?"positive":null},{info:t.t("queues.status.failed"),value:String(((j=a.by_status)==null?void 0:j.failed)||0),theme:((h=a.by_status)==null?void 0:h.failed)>0?"negative":null}]});function c(a={}){const d={timeRange:e.timeRange,jobType:e.jobType,sortBy:e.sortBy,sortOrder:e.sortOrder,page:e.page,...a},g={timeRange:"24h",jobType:"",sortBy:"created_at",sortOrder:"desc",page:1},_=new URLSearchParams;for(const[m,v]of Object.entries(d))v&&v!==g[m]&&_.set(m,v.toString());return _.toString()?"?"+_.toString():""}const p=y(()=>{const a=c({page:void 0});return[{name:"all",label:t.t("queues.all"),icon:"list-bullet",link:"/queues"+a},{name:"pending",label:t.t("queues.status.pending"),icon:"clock",link:"/queues/pending"+a},{name:"running",label:t.t("queues.status.running"),icon:"play",link:"/queues/running"+a},{name:"completed",label:t.t("queues.status.completed"),icon:"check",link:"/queues/completed"+a},{name:"failed",label:t.t("queues.status.failed"),icon:"alert",link:"/queues/failed"+a}]}),b=[{value:"1h",label:t.t("queues.timeRange.lastHour")},{value:"24h",label:t.t("queues.timeRange.last24Hours")},{value:"7d",label:t.t("queues.timeRange.last7Days")},{value:"30d",label:t.t("queues.timeRange.last30Days")},{value:"all",label:t.t("queues.timeRange.allTime")}],f=y(()=>{const a={name:{label:t.t("queues.job.name"),type:"text",sortable:!0},queue:{label:t.t("queues.job.queue"),type:"text",sortable:!0}};return e.status==="all"&&(a.status={label:t.t("queues.job.status"),type:"queue-status",sortable:!0}),a.created_at={label:t.t("queues.job.created"),type:"date",display:"DD.MM.YYYY HH:mm",sortable:!0},a.attempts={label:t.t("queues.job.attempts"),type:"queue-attempts",mobile:!1,sortable:!0,width:"1/12"},a});function i(a={}){const d=window.location.pathname.replace(/^\/panel/,"");n.$go(d+c(a))}function w(a){var m;const d=a.columnIndex;if(!((m=f.value[d])!=null&&m.sortable))return;let g=d,_="asc";e.sortBy===d&&(e.sortOrder==="asc"?_="desc":e.sortOrder==="desc"&&(d==="created_at"?_="asc":(g="created_at",_="desc"))),i({sortBy:g,sortOrder:_,page:1})}return{__sfc:!0,props:e,panel:t,app:n,limit:o,transformedJobs:l,reports:r,buildQueryString:c,tabs:p,timeRanges:b,columns:f,navigate:i,onHeader:w}}};var C=function(){var e=this,t=e._self._c,n=e._self._setupProxy;return t("k-panel-inside",{staticClass:"k-queues-view"},[t("k-header",{scopedSlots:e._u([{key:"buttons",fn:function(){var o,l;return[t("k-button-group",[e.jobTypes.length>0?t("k-dropdown",[t("k-button",{attrs:{icon:"filter",variant:"filled",size:"sm"},on:{click:function(r){return e.$refs.jobtype.toggle()}}},[e._v(" "+e._s(((o=n.props.jobTypes.find(r=>r.value===n.props.jobType))==null?void 0:o.label)??e.$t("queues.jobType.all"))+" ")]),t("k-dropdown-content",{ref:"jobtype",attrs:{"align-x":"end"}},[t("k-dropdown-item",{attrs:{current:!e.jobType},on:{click:function(r){return n.navigate({jobType:void 0,page:1})}}},[e._v(" "+e._s(e.$t("queues.jobType.all"))+" ")]),t("hr"),e._l(e.jobTypes,function(r){return t("k-dropdown-item",{key:r.value,attrs:{current:e.jobType===r.value},on:{click:function(c){return n.navigate({jobType:r.value,page:1})}}},[e._v(" "+e._s(r.label)+" ")])})],2)],1):e._e(),t("k-dropdown",[t("k-button",{attrs:{icon:"calendar",variant:"filled",size:"sm"},on:{click:function(r){return e.$refs.timerange.toggle()}}},[e._v(" "+e._s(((l=n.timeRanges.find(r=>r.value===n.props.timeRange))==null?void 0:l.label)??e.$t("queues.timeRange.last24Hours"))+" ")]),t("k-dropdown-content",{ref:"timerange",attrs:{"align-x":"end"}},e._l(n.timeRanges,function(r){return t("k-dropdown-item",{key:r.value,attrs:{current:e.timeRange===r.value},on:{click:function(c){return n.navigate({timeRange:r.value,page:1})}}},[e._v(" "+e._s(r.label)+" ")])}),1)],1),t("k-button",{attrs:{icon:"refresh",variant:"filled",size:"sm"},on:{click:function(r){return n.app.$reload()}}})],1)]},proxy:!0}])},[e._v(" "+e._s(e.$t("queues.jobs"))+" ")]),t("k-stats",{attrs:{reports:n.reports,size:"large"}}),t("k-tabs",{attrs:{tab:n.props.status,tabs:n.tabs}}),n.transformedJobs.length===0?t("k-empty",{attrs:{icon:"list-bullet"}},[e._v(" "+e._s(e.$t("queues.empty"))+" ")]):t("k-table",{attrs:{columns:n.columns,rows:n.transformedJobs},on:{header:n.onHeader},scopedSlots:e._u([{key:"header",fn:function({columnIndex:o,label:l}){return[n.columns[o]&&n.columns[o].sortable?t("span",{attrs:{"data-sortable":"true"}},[e._v(" "+e._s(l)+" "),o===e.sortBy?t("k-icon",{attrs:{type:e.sortOrder==="asc"?"angle-up":"angle-down"}}):e._e()],1):t("span",[e._v(e._s(l))])]}},{key:"options",fn:function({row:o}){return[t("k-button",{attrs:{icon:"dots",size:"xs"},on:{click:function(l){return n.panel.drawer.open("queues/jobs/"+o.id)}}})]}}])}),n.transformedJobs.length>0&&e.total>n.limit?t("footer",{staticClass:"k-bar k-collection-footer"},[t("k-pagination",{attrs:{page:e.page,total:e.total,limit:n.limit,details:!0,align:"right"},on:{paginate:o=>n.navigate({page:o.page})}})],1):e._e()],1)},O=[],T=k(R,C,O);const x=T.exports,B={__name:"status-preview",props:{value:String},setup(u){return{__sfc:!0,ICONS:{pending:"clock",running:"play",completed:"check",failed:"alert"}}}};var D=function(){var e=this,t=e._self._c,n=e._self._setupProxy;return t("span",{staticClass:"k-queue-status-preview k-text-field-preview",attrs:{"data-status":e.value}},[t("k-icon",{attrs:{type:n.ICONS[e.value]||"circle"}}),t("span",{staticClass:"k-queue-status-preview-text"},[e._v(" "+e._s(e.$t(`queues.status.${e.value}`))+" ")])],1)},P=[],A=k(B,D,P);const I=A.exports,N={__name:"attempts-preview",props:{value:{type:Number,default:0}},setup(u){return{__sfc:!0}}};var z=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("span",{staticClass:"k-queue-attempts-preview k-text-field-preview"},[e.value>0?[e._v(" "+e._s(e.value)+" "),t("k-icon",{attrs:{title:e.title,type:"refresh"}})]:t("p",[e._v("â€“")])],2)},H=[],J=k(N,z,H);const M=J.exports,F={__name:"job-drawer",props:{...{disabled:Boolean},...{icon:{type:String}},...{id:{type:[Number,String],default(){return this._uid}}},...{options:{default:()=>[],type:Array}},breadcrumb:{default:()=>[],type:Array},tab:{type:String},tabs:{default:()=>({}),type:Object},title:String,visible:{default:!1,type:Boolean},job:{type:Object,required:!0},value:{type:Object,default:()=>({})},submitButton:[String,Boolean]},emits:["cancel","crumb","input","tab"],setup(u){const e=u,t=q(),n=y(()=>{var r,c,p,b,f;const o=((r=e.job)==null?void 0:r.status)||"pending",l={pending:"warning",running:"info",completed:"positive",failed:"negative"};return[{info:t.t("queues.job.status"),value:t.t("queues.status."+o),theme:l[o]},{info:t.t("queues.job.queue"),value:((c=e.job)==null?void 0:c.queue)||"default"},{info:t.t("queues.job.attempts"),value:`${((p=e.job)==null?void 0:p.attempts)||0} / ${((b=e.job)==null?void 0:b.max_attempts)||3}`},{info:t.t("queues.job.created"),value:new Date(((f=e.job)==null?void 0:f.created_at)*1e3).toLocaleString()}]});return{__sfc:!0,props:e,panel:t,reports:n}}};var U=function(){var o,l,r,c,p,b,f;var e=this,t=e._self._c,n=e._self._setupProxy;return t("k-drawer",e._b({ref:"drawer",staticClass:"k-queues-job-drawer",on:{cancel:function(i){return e.$emit("cancel")},crumb:function(i){return e.$emit("crumb",i)},submit:function(i){return e.$emit("cancel")},tab:function(i){return e.$emit("tab",i)}}},"k-drawer",e.$props,!1),[t("k-stats",{attrs:{reports:n.reports,size:"small"}}),(o=n.props.job)!=null&&o.error?t("k-section",{attrs:{label:e.$t("queues.job.error")}},[t("k-box",{staticClass:"k-queues-job-error",attrs:{theme:"negative"}},[e._v(" "+e._s((l=n.props.job)==null?void 0:l.error)+" ")])],1):e._e(),JSON.stringify((r=n.props.job)==null?void 0:r.payload)!=="[]"?t("k-section",{attrs:{label:e.$t("queues.drawer.payload")}},[t("k-code",{attrs:{language:"json"}},[e._v(e._s(JSON.stringify(((c=n.props.job)==null?void 0:c.payload)||{},null,2)))])],1):e._e(),((f=(b=(p=n.props)==null?void 0:p.job)==null?void 0:b.logs)==null?void 0:f.length)>0?t("k-section",{attrs:{label:e.$t("queues.drawer.logs")}},[t("div",{staticClass:"k-queues-job-logs"},e._l(n.props.job.logs,function(i,w){return t("div",{key:w,staticClass:"k-queues-job-log-entry",attrs:{"data-level":i.level}},[t("time",{staticClass:"k-queues-job-log-time"},[e._v(e._s(new Date(i.timestamp*1e3).toLocaleString()))]),t("span",{staticClass:"k-queues-job-log-level"},[e._v(e._s(i.level))]),t("span",{staticClass:"k-queues-job-log-message"},[e._v(e._s(i.message))])])}),0)]):t("k-section",{attrs:{label:e.$t("queues.drawer.logs")}},[t("k-empty",{attrs:{icon:"list-bullet"}},[e._v(" "+e._s(e.$t("queues.drawer.logs.empty"))+" ")])],1)],1)},L=[],V=k(F,U,L);const Y=V.exports;panel.plugin("tobimori/queues",{components:{"k-queues-view":x,"k-queue-status-field-preview":I,"k-queue-attempts-field-preview":M,"k-queues-job-drawer":Y}})})();
