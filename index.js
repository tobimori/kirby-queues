(function(){"use strict";const s=window.Vue;function q(){return window.panel}function $(){return q().app}const y=s.computed;s.customRef,s.defineAsyncComponent,s.defineComponent,s.effectScope,s.getCurrentInstance,s.getCurrentScope,s.h,s.inject,s.isProxy,s.isReactive,s.isReadonly,s.isRef,s.isShallow,s.markRaw,s.nextTick,s.onActivated,s.onBeforeMount,s.onBeforeUnmount,s.onBeforeUpdate,s.onDeactivated,s.onErrorCaptured,s.onMounted,s.onRenderTracked,s.onRenderTriggered,s.onScopeDispose,s.onServerPrefetch,s.onUnmounted,s.onUpdated,s.provide,s.proxyRefs,s.reactive,s.readonly,s.ref,s.shallowReactive,s.shallowReadonly,s.shallowRef,s.toRaw,s.toRef,s.toRefs,s.triggerRef,s.unref,s.useAttrs,s.useCssModule,s.useCssVars,s.useListeners,s.useSlots,s.watch,s.watchEffect,s.watchPostEffect,s.watchSyncEffect;function k(i,e,t,a,o,l,r,p){var d=typeof i=="function"?i.options:i;return e&&(d.render=e,d.staticRenderFns=t,d._compiled=!0),{exports:i,options:d}}const R={__name:"view",props:{statistics:Object,jobs:Array,total:Number,status:{type:String,default:"pending"},page:{type:Number,default:1},timeRange:{type:String,default:"24h"},sortBy:{type:String,default:"created_at"},sortOrder:{type:String,default:"desc"},jobType:{type:String,default:""},jobTypes:{type:Array,default:()=>[]}},setup(i){const e=i,t=q(),a=$(),o=50,l=y(()=>(e.jobs??[]).map(n=>({id:n.id,name:n.name||n.type,type:n.type,queue:n.queue,status:n.status,attempts:n.attempts||0,created_at:n.created_at?new Date(n.created_at*1e3).toISOString():null,started_at:n.started_at?new Date(n.started_at*1e3).toISOString():null,completed_at:n.completed_at?new Date(n.completed_at*1e3).toISOString():null,failed_at:n.failed_at?new Date(n.failed_at*1e3).toISOString():null}))),r=y(()=>{var u,f,_,b,v,S,j,h;const n=e.statistics||{total:0,by_status:{}};return[{info:t.t("queues.total"),value:String(n.total||0)},{info:t.t("queues.status.pending"),value:String(((u=n.by_status)==null?void 0:u.pending)||0),theme:((f=n.by_status)==null?void 0:f.pending)>0?"yellow":null},{info:t.t("queues.status.running"),value:String(((_=n.by_status)==null?void 0:_.running)||0),theme:((b=n.by_status)==null?void 0:b.running)>0?"blue":null},{info:t.t("queues.status.completed"),value:String(((v=n.by_status)==null?void 0:v.completed)||0),theme:((S=n.by_status)==null?void 0:S.completed)>0?"positive":null},{info:t.t("queues.status.failed"),value:String(((j=n.by_status)==null?void 0:j.failed)||0),theme:((h=n.by_status)==null?void 0:h.failed)>0?"negative":null}]});function p(n={}){const u={timeRange:e.timeRange,jobType:e.jobType,sortBy:e.sortBy,sortOrder:e.sortOrder,page:e.page,...n},f={timeRange:"24h",jobType:"",sortBy:"created_at",sortOrder:"desc",page:1},_=new URLSearchParams;for(const[b,v]of Object.entries(u))v&&v!==f[b]&&_.set(b,v.toString());return _.toString()?"?"+_.toString():""}const d=y(()=>{const n=p({page:void 0});return[{name:"all",label:t.t("queues.all"),icon:"list-bullet",link:"/queues"+n},{name:"pending",label:t.t("queues.status.pending"),icon:"clock",link:"/queues/pending"+n},{name:"running",label:t.t("queues.status.running"),icon:"play",link:"/queues/running"+n},{name:"completed",label:t.t("queues.status.completed"),icon:"check",link:"/queues/completed"+n},{name:"failed",label:t.t("queues.status.failed"),icon:"alert",link:"/queues/failed"+n}]}),g=[{value:"1h",label:t.t("queues.timeRange.lastHour")},{value:"24h",label:t.t("queues.timeRange.last24Hours")},{value:"7d",label:t.t("queues.timeRange.last7Days")},{value:"30d",label:t.t("queues.timeRange.last30Days")},{value:"all",label:t.t("queues.timeRange.allTime")}],m=y(()=>{const n={name:{label:t.t("queues.job.name"),type:"text",sortable:!0},queue:{label:t.t("queues.job.queue"),type:"text",sortable:!0}};return e.status==="all"&&(n.status={label:t.t("queues.job.status"),type:"queue-status",sortable:!0}),n.created_at={label:t.t("queues.job.created"),type:"date",display:"DD.MM.YYYY HH:mm",sortable:!0},n.attempts={label:t.t("queues.job.attempts"),type:"queue-attempts",mobile:!1,sortable:!0,width:"1/12"},n});function c(n={}){const u=window.location.pathname.replace(/^\/panel/,"");a.$go(u+p(n))}function w(n){var b;const u=n.columnIndex;if(!((b=m.value[u])!=null&&b.sortable))return;let f=u,_="asc";e.sortBy===u&&(e.sortOrder==="asc"?_="desc":e.sortOrder==="desc"&&(u==="created_at"?_="asc":(f="created_at",_="desc"))),c({sortBy:f,sortOrder:_,page:1})}async function E(n){const u=e.jobs.find(f=>f.id===n);u&&await t.drawer.open({component:"k-queues-job-drawer",props:{title:u.name||u.type,icon:"list-bullet",job:u}})}return{__sfc:!0,props:e,panel:t,app:a,limit:o,transformedJobs:l,reports:r,buildQueryString:p,tabs:d,timeRanges:g,columns:m,navigate:c,onHeader:w,openJobDrawer:E}}};var C=function(){var e=this,t=e._self._c,a=e._self._setupProxy;return t("k-panel-inside",{staticClass:"k-queues-view"},[t("k-header",{scopedSlots:e._u([{key:"buttons",fn:function(){var o,l;return[t("k-button-group",[e.jobTypes.length>0?t("k-dropdown",[t("k-button",{attrs:{icon:"filter",variant:"filled",size:"sm"},on:{click:function(r){return e.$refs.jobtype.toggle()}}},[e._v(" "+e._s(((o=a.props.jobTypes.find(r=>r.value===a.props.jobType))==null?void 0:o.label)??e.$t("queues.jobType.all"))+" ")]),t("k-dropdown-content",{ref:"jobtype",attrs:{"align-x":"end"}},[t("k-dropdown-item",{attrs:{current:!e.jobType},on:{click:function(r){return a.navigate({jobType:void 0,page:1})}}},[e._v(" "+e._s(e.$t("queues.jobType.all"))+" ")]),t("hr"),e._l(e.jobTypes,function(r){return t("k-dropdown-item",{key:r.value,attrs:{current:e.jobType===r.value},on:{click:function(p){return a.navigate({jobType:r.value,page:1})}}},[e._v(" "+e._s(r.label)+" ")])})],2)],1):e._e(),t("k-dropdown",[t("k-button",{attrs:{icon:"calendar",variant:"filled",size:"sm"},on:{click:function(r){return e.$refs.timerange.toggle()}}},[e._v(" "+e._s(((l=a.timeRanges.find(r=>r.value===a.props.timeRange))==null?void 0:l.label)??e.$t("queues.timeRange.last24Hours"))+" ")]),t("k-dropdown-content",{ref:"timerange",attrs:{"align-x":"end"}},e._l(a.timeRanges,function(r){return t("k-dropdown-item",{key:r.value,attrs:{current:e.timeRange===r.value},on:{click:function(p){return a.navigate({timeRange:r.value,page:1})}}},[e._v(" "+e._s(r.label)+" ")])}),1)],1),t("k-button",{attrs:{icon:"refresh",variant:"filled",size:"sm"},on:{click:function(r){return a.app.$reload()}}})],1)]},proxy:!0}])},[e._v(" "+e._s(e.$t("queues.jobs"))+" ")]),t("k-stats",{attrs:{reports:a.reports,size:"large"}}),t("k-tabs",{attrs:{tab:a.props.status,tabs:a.tabs}}),a.transformedJobs.length===0?t("k-empty",{attrs:{icon:"list-bullet"}},[e._v(" "+e._s(e.$t("queues.empty"))+" ")]):t("k-table",{attrs:{columns:a.columns,rows:a.transformedJobs},on:{header:a.onHeader},scopedSlots:e._u([{key:"header",fn:function({columnIndex:o,label:l}){return[a.columns[o]&&a.columns[o].sortable?t("span",{attrs:{"data-sortable":"true"}},[e._v(" "+e._s(l)+" "),o===e.sortBy?t("k-icon",{attrs:{type:e.sortOrder==="asc"?"angle-up":"angle-down"}}):e._e()],1):t("span",[e._v(e._s(l))])]}},{key:"options",fn:function({row:o}){return[t("k-button",{attrs:{icon:"dots",size:"xs"},on:{click:function(l){return a.openJobDrawer(o.id)}}})]}}])}),a.transformedJobs.length>0&&e.total>a.limit?t("footer",{staticClass:"k-bar k-collection-footer"},[t("k-pagination",{attrs:{page:e.page,total:e.total,limit:a.limit,details:!0,align:"right"},on:{paginate:o=>a.navigate({page:o.page})}})],1):e._e()],1)},O=[],T=k(R,C,O);const x=T.exports,B={__name:"status-preview",props:{value:String},setup(i){return{__sfc:!0,ICONS:{pending:"clock",running:"play",completed:"check",failed:"alert"}}}};var D=function(){var e=this,t=e._self._c,a=e._self._setupProxy;return t("span",{staticClass:"k-queue-status-preview k-text-field-preview",attrs:{"data-status":e.value}},[t("k-icon",{attrs:{type:a.ICONS[e.value]||"circle"}}),t("span",{staticClass:"k-queue-status-preview-text"},[e._v(" "+e._s(e.$t(`queues.status.${e.value}`))+" ")])],1)},P=[],A=k(B,D,P);const I=A.exports,J={__name:"attempts-preview",props:{value:{type:Number,default:0}},setup(i){return{__sfc:!0}}};var N=function(){var e=this,t=e._self._c;return e._self._setupProxy,t("span",{staticClass:"k-queue-attempts-preview k-text-field-preview"},[e.value>0?[e._v(" "+e._s(e.value)+" "),t("k-icon",{attrs:{title:e.title,type:"refresh"}})]:t("p",[e._v("â€“")])],2)},z=[],H=k(J,N,z);const M=H.exports,F={__name:"job-drawer",props:{...{disabled:Boolean},...{icon:{type:String}},...{id:{type:[Number,String],default(){return this._uid}}},...{options:{default:()=>[],type:Array}},breadcrumb:{default:()=>[],type:Array},tab:{type:String},tabs:{default:()=>({}),type:Object},title:String,visible:{default:!1,type:Boolean},job:{type:Object,required:!0},value:{type:Object,default:()=>({})},submitButton:[String,Boolean]},emits:["cancel","crumb","input","tab"],setup(i){const e=i,t=q(),a=y(()=>{var r,p,d,g,m;const o=((r=e.job)==null?void 0:r.status)||"pending",l={pending:"warning",running:"info",completed:"positive",failed:"negative"};return[{info:t.t("queues.job.status"),value:t.t("queues.status."+o),theme:l[o]},{info:t.t("queues.job.queue"),value:((p=e.job)==null?void 0:p.queue)||"default"},{info:t.t("queues.job.attempts"),value:`${((d=e.job)==null?void 0:d.attempts)||0} / ${((g=e.job)==null?void 0:g.max_attempts)||3}`},{info:t.t("queues.job.created"),value:new Date(((m=e.job)==null?void 0:m.created_at)*1e3).toLocaleString()}]});return{__sfc:!0,props:e,panel:t,reports:a}}};var U=function(){var o,l,r,p,d,g,m;var e=this,t=e._self._c,a=e._self._setupProxy;return t("k-drawer",e._b({ref:"drawer",staticClass:"k-queues-job-drawer",on:{cancel:function(c){return e.$emit("cancel")},crumb:function(c){return e.$emit("crumb",c)},submit:function(c){return e.$emit("cancel")},tab:function(c){return e.$emit("tab",c)}}},"k-drawer",e.$props,!1),[t("k-stats",{attrs:{reports:a.reports,size:"small"}}),(o=a.props.job)!=null&&o.error?t("k-section",{attrs:{label:e.$t("queues.job.error")}},[t("k-box",{staticClass:"k-queues-job-error",attrs:{theme:"negative"}},[e._v(" "+e._s((l=a.props.job)==null?void 0:l.error)+" ")])],1):e._e(),JSON.stringify((r=a.props.job)==null?void 0:r.payload)!=="[]"?t("k-section",{attrs:{label:e.$t("queues.drawer.payload")}},[t("k-code",{attrs:{language:"json"}},[e._v(e._s(JSON.stringify(((p=a.props.job)==null?void 0:p.payload)||{},null,2)))])],1):e._e(),((m=(g=(d=a.props)==null?void 0:d.job)==null?void 0:g.logs)==null?void 0:m.length)>0?t("k-section",{attrs:{label:e.$t("queues.drawer.logs")}},[t("div",{staticClass:"k-queues-job-logs"},e._l(a.props.job.logs,function(c,w){return t("div",{key:w,staticClass:"k-queues-job-log-entry",attrs:{"data-level":c.level}},[t("time",{staticClass:"k-queues-job-log-time"},[e._v(e._s(new Date(c.timestamp*1e3).toLocaleString()))]),t("span",{staticClass:"k-queues-job-log-level"},[e._v(e._s(c.level))]),t("span",{staticClass:"k-queues-job-log-message"},[e._v(e._s(c.message))])])}),0)]):t("k-section",{attrs:{label:e.$t("queues.drawer.logs")}},[t("k-empty",{attrs:{icon:"list-bullet"}},[e._v(" "+e._s(e.$t("queues.drawer.logs.empty"))+" ")])],1)],1)},L=[],V=k(F,U,L);const Y=V.exports;panel.plugin("tobimori/queues",{components:{"k-queues-view":x,"k-queue-status-field-preview":I,"k-queue-attempts-field-preview":M,"k-queues-job-drawer":Y}})})();
